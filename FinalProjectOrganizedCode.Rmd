---
title: "shinyApp"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Load packages:
```{r}
library(shiny)
library(shinythemes)
library(bslib)
library(tidyverse)
library(plotly)
library(ggplot2)
library(rjson)
```

import CDC vaccination data:

```{r}

cdcData_unprocessed <- read_csv("data/covid19_vaccinations_in_the_united_states.csv", skip = 2) 
cdcData_unprocessed <- cdcData_unprocessed %>% rename_with(~ gsub(" ", "_", names(cdcData_unprocessed)))
cdcData_unprocessed <- cdcData_unprocessed %>% rename_with(~ gsub("/", "_", names(cdcData_unprocessed)))
cdcData_unprocessed <- cdcData_unprocessed %>% mutate(State_Territory_Federal_Entity = gsub(" State", "", State_Territory_Federal_Entity))

#I need to merge the hexgrid info with the info above:
stateInfo <- read_csv("data/us_states_hexgrid.csv") %>% 
  select(-the_geom, -cartodb_id, -created_at, -updated_at, -bees) %>%
  mutate(google_name = gsub(" \\(United States\\)", "", google_name))

cdcData <- left_join(stateInfo, cdcData_unprocessed, by = c("google_name" = "State_Territory_Federal_Entity"))



#I think I need to split the data into two data frames: one where company is a variable, and one where it is not:

cdcData_agnostic <- cdcData %>% 
  select(contains("label", ignore.case = TRUE) |
           contains("iso", ignore.case = TRUE) |
           contains("google", ignore.case = TRUE) |
           contains("100k", ignore.case=TRUE)) %>%
  na_if("N/A") %>% 
  drop_na()

colnames(cdcData_agnostic) <- c("Shortened", "ISOname", "Name",
                               "Total_DeliveredPer100K", 
                               "18plus_DeliveredPer100K", 
                               "Total_AdministeredPer100K", 
                               "18plus_AdministeredPer100K", 
                               "65plus_AdministeredPer100K",
                               "65plus_DeliveredPer100K")

cdcData_agnostic <- cdcData_agnostic %>%
  mutate_at(vars("Shortened", "ISOname", "Name",
                               "Total_DeliveredPer100K", 
                               "18plus_DeliveredPer100K", 
                               "Total_AdministeredPer100K", 
                               "18plus_AdministeredPer100K", 
                               "65plus_AdministeredPer100K",
                               "65plus_DeliveredPer100K"), 
            list(factor))

cdcData_agnosticLong <- cdcData_agnostic %>%
  pivot_longer(
    !c(Shortened, ISOname, Name),
    names_to= c("Group", ".value"),
    names_sep="_")

cdcData_company <- cdcData %>% select(contains("label", ignore.case = TRUE) |
                                        contains("iso", ignore.case = TRUE) |
                                        contains("google", ignore.case = TRUE) |
                                        contains("moderna", ignore.case=TRUE) | 
                                         contains("pfizer", ignore.case=TRUE) | 
                                         contains("janssen", ignore.case=TRUE))

colnames(cdcData_company) <- c("Shortened", "ISOname", "Name",
                               "TotalDelivered_Moderna", 
                               "TotalAdministered_Moderna", 
                               "PeopleFullyVaccinated_Moderna", 
                               "18plusFullyVaccinated_Moderna", 
                               "65plusFullyVaccinated_Moderna",
                               "TotalDelivered_Pfizer", 
                               "TotalAdministered_Pfizer", 
                               "PeopleFullyVaccinated_Pfizer", 
                               "18plusFullyVaccinated_Pfizer", 
                               "65plusFullyVaccinated_Pfizer",
                               "TotalDelivered_Janssen", 
                               "TotalAdministered_Janssen", 
                               "PeopleFullyVaccinated_Janssen", 
                               "18plusFullyVaccinated_Janssen", 
                               "65plusFullyVaccinated_Janssen")


cdcDataLong <- cdcData_company %>%
  pivot_longer(
    !c(Shortened, ISOname, Name),
    names_to= c(".value", "manufacturer"),
    names_sep="_")

write_rds(cdcData_agnosticLong, "data/cdcData_agnosticLong.rds")

```

I'm curious to see how much of a pain it would be to incorporate the time data:

```{r}

modernaTimeLine <- read_csv("data/COVID-19_Vaccine_Distribution_Allocations_by_Jurisdiction_-_Moderna.csv")

```

